<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB Data Exporter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .preset-btn { margin: 2px; font-size: 0.85rem; }
        #weekPresets { display: flex; flex-wrap: wrap; justify-content: space-between; }
        #weekPresets .preset-btn {
            flex: 0 0 calc(25% - 10px); min-width: 120px; margin-bottom: 8px;
            text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        @media (max-width: 768px) { #weekPresets .preset-btn { flex: 0 0 calc(50% - 10px); } }
        @media (max-width: 576px) { #weekPresets .preset-btn { flex: 0 0 100%; } }
        .file-list-group-item { display: flex; justify-content: space-between; align-items: center; }
        /* Style for the mode switch tabs */
        .nav-pills .nav-link { cursor: pointer; }
    </style>
</head>
<body>
    <div class="container mt-4 mb-5">
        <h1 class="text-center mb-4"><i class="fas fa-database me-2"></i>MongoDB Data Exporter</h1>

        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-file-export me-2"></i>Export Configuration</h5>
                    </div>
                    <div class="card-body">

                        <!-- 1. Target Selection -->
                        <div class="mb-4">
                            <label for="exportTarget" class="form-label fw-bold">Target Database</label>
                            <select class="form-select" id="exportTarget">
                                <option value="archive" selected>Intelligence Archive (Default)</option>
                                <option value="cache">Intelligence Cache</option>
                                <option value="all">Export Both (Archive & Cache)</option>
                            </select>
                        </div>

                        <hr>

                        <!-- 2. Mode Selection (Tabs) -->
                        <label class="form-label fw-bold mb-2">Export Mode</label>
                        <ul class="nav nav-pills nav-fill mb-4" id="modeTabs">
                            <li class="nav-item">
                                <a class="nav-link active" id="tab-range" onclick="switchMode('range')">
                                    <i class="fas fa-calendar-alt me-2"></i>Time Range
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="tab-all" onclick="switchMode('all')">
                                    <i class="fas fa-globe me-2"></i>Export All Data
                                </a>
                            </li>
                        </ul>

                        <!-- 3. Dynamic Configuration Area -->

                        <!-- A. Time Range Configuration -->
                        <div id="config-range">
                            <h5 class="text-secondary"><i class="fas fa-clock me-2"></i>Select Period</h5>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="startDate" class="form-label">Start Date</label>
                                    <input type="datetime-local" class="form-control" id="startDate">
                                </div>
                                <div class="col-md-6">
                                    <label for="endDate" class="form-label">End Date</label>
                                    <input type="datetime-local" class="form-control" id="endDate">
                                </div>
                            </div>

                            <!-- Presets -->
                            <div class="mb-3">
                                <h6 class="text-muted small text-uppercase">Presets</h6>
                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="togglePresets('month')">Show Months</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="togglePresets('week')">Show Weeks</button>
                            </div>

                            <div id="monthPresetsContainer" class="d-none mb-3">
                                <div class="date-presets" id="monthPresets"></div>
                            </div>
                            <div id="weekPresetsContainer" class="d-none mb-3">
                                <div class="date-presets" id="weekPresets"></div>
                            </div>
                        </div>

                        <!-- B. Export All Configuration -->
                        <div id="config-all" class="d-none">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                This will export <strong>all data</strong> from the beginning of time.
                                <br>To prevent generating one massive file, please select a split strategy.
                            </div>

                            <label for="splitBy" class="form-label fw-bold">Split Files By</label>
                            <select class="form-select" id="splitBy">
                                <option value="month" selected>Monthly (Recommended)</option>
                                <option value="week">Weekly</option>
                                <option value="year">Yearly</option>
                                <option value="none">No Split (Single Huge File)</option>
                            </select>
                        </div>

                        <hr class="mt-4">

                        <!-- 4. Action Buttons -->
                        <div class="row mt-3">
                            <div class="col">
                                <button id="exportBtn" class="btn btn-primary w-100 py-2">
                                    <span id="btnSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                    <span id="btnText"><i class="fas fa-download me-2"></i>Start Export</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress & Results (Same as before) -->
                <div class="progress mt-3 d-none" id="progressContainer" style="height: 25px;">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 0%">Processing...</div>
                </div>
                <div id="resultAlert" class="alert d-none mt-3">
                    <i class="fas fa-info-circle me-2"></i><span id="resultMessage"></span>
                </div>
                <div id="downloadSection" class="card mt-3 d-none border-success">
                    <div class="card-header bg-success text-white"><i class="fas fa-check-circle me-2"></i>Export Ready</div>
                    <ul class="list-group list-group-flush" id="fileList"></ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentMode = 'range';

        document.addEventListener('DOMContentLoaded', function() {
            initDateInputs();
            generateMonthPresets();
            generateWeekPresets();
            document.getElementById('exportBtn').addEventListener('click', startExport);
        });

        function initDateInputs() {
            const now = new Date();
            const oneHourAgo = new Date(now.getTime() - (3600 * 1000));
            document.getElementById('startDate').value = formatLocalISO(oneHourAgo);
            document.getElementById('endDate').value = formatLocalISO(now);
        }

        function switchMode(mode) {
            currentMode = mode;
            // Toggle Tabs UI
            document.getElementById('tab-range').classList.toggle('active', mode === 'range');
            document.getElementById('tab-all').classList.toggle('active', mode === 'all');

            // Toggle Config Areas
            document.getElementById('config-range').classList.toggle('d-none', mode !== 'range');
            document.getElementById('config-all').classList.toggle('d-none', mode !== 'all');
        }

        function togglePresets(type) {
            const container = document.getElementById(type + 'PresetsContainer');
            container.classList.toggle('d-none');
        }

        function formatLocalISO(date) {
            const pad = n => String(n).padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }

        function startExport() {
            const target = document.getElementById('exportTarget').value;
            const payload = { target: target, mode: currentMode };

            if (currentMode === 'range') {
                const s = document.getElementById('startDate').value;
                const e = document.getElementById('endDate').value;
                if (!s || !e) return showResult('Please select start and end dates.', 'danger');
                payload.startDate = s.length === 16 ? s + ':00' : s;
                payload.endDate = e.length === 16 ? e + ':00' : e;
            } else {
                // Export All Mode
                payload.splitBy = document.getElementById('splitBy').value;
            }

            resetUI();
            setLoading(true);

            fetch('/maintenance/export_mongodb', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            })
            .then(res => res.ok ? res.json() : res.json().then(e => { throw new Error(e.message) }))
            .then(data => {
                if (data.status === 'success' || data.status === 'warning') {
                    updateProgress(100);
                    showResult(data.message, data.status === 'success' ? 'success' : 'warning');
                    if (data.files && data.files.length > 0) renderDownloadLinks(data.files);
                } else {
                    showResult(data.message, 'danger');
                }
            })
            .catch(err => showResult(`Error: ${err.message}`, 'danger'))
            .finally(() => setLoading(false));
        }

        // --- Helper Functions (Same as before) ---
        function generateMonthPresets() {
            const container = document.getElementById('monthPresets');
            const now = new Date();
            for (let i = 0; i < 12; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const start = new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0);
                const end = new Date(d.getFullYear(), d.getMonth() + 1, 0, 23,59,59);
                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-primary preset-btn';
                btn.textContent = start.toLocaleDateString('en-US', {month:'short', year:'numeric'});
                btn.onclick = () => {
                    document.getElementById('startDate').value = formatLocalISO(start);
                    document.getElementById('endDate').value = formatLocalISO(end);
                };
                container.appendChild(btn);
            }
        }

        function generateWeekPresets() {
            const container = document.getElementById('weekPresets');
            const now = new Date();
            for(let i=0; i<52; i++) {
                const d = new Date(now); d.setDate(now.getDate() - (7*i));
                const day = d.getDay(); const diff = d.getDate() - day + (day == 0 ? -6:1);
                const start = new Date(d.setDate(diff)); start.setHours(0,0,0,0);
                const end = new Date(start); end.setDate(start.getDate()+6); end.setHours(23,59,59);

                const btn = document.createElement('button');
                btn.className = 'btn btn-outline-secondary preset-btn';
                btn.textContent = `Week of ${start.toLocaleDateString('en-US', {month:'numeric', day:'numeric'})}`;
                btn.onclick = () => {
                    document.getElementById('startDate').value = formatLocalISO(start);
                    document.getElementById('endDate').value = formatLocalISO(end);
                };
                container.appendChild(btn);
            }
        }

        function renderDownloadLinks(files) {
            const list = document.getElementById('fileList');
            list.innerHTML = '';
            document.getElementById('downloadSection').classList.remove('d-none');
            files.forEach(f => {
                const fname = f.split(/[\\/]/).pop();
                list.innerHTML += `<li class="list-group-item file-list-group-item">
                    <span>${fname}</span>
                    <a href="/download/${fname}" class="btn btn-sm btn-outline-success" download>Download</a>
                </li>`;
            });
        }

        function resetUI() {
            document.getElementById('downloadSection').classList.add('d-none');
            document.getElementById('resultAlert').classList.add('d-none');
        }
        function setLoading(loading) {
            const btn = document.getElementById('exportBtn');
            const spinner = document.getElementById('btnSpinner');
            btn.disabled = loading;
            spinner.classList.toggle('d-none', !loading);
            document.getElementById('progressContainer').classList.toggle('d-none', !loading);
        }
        function updateProgress(p) {
            const bar = document.getElementById('progressBar');
            bar.style.width = p + '%';
            bar.textContent = p < 100 ? 'Processing...' : 'Done';
            bar.className = p < 100 ? 'progress-bar progress-bar-striped progress-bar-animated bg-info' : 'progress-bar bg-success';
        }
        function showResult(msg, type) {
            const alert = document.getElementById('resultAlert');
            alert.className = `alert alert-${type} mt-3`;
            alert.textContent = msg;
            alert.classList.remove('d-none');
        }
    </script>
</body>
</html>
